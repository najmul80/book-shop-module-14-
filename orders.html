<!doctype html>
<html lang="en">

    <head>
        
        <meta charset="utf-8" />
        <title>Dashboard | Books</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta content="Premium Multipurpose Admin & Dashboard Template" name="description" />
        <meta content="Themesbrand" name="author" />
        <!-- App favicon -->
        <link rel="shortcut icon" href="assets/images/favicon.ico">

        <!-- Bootstrap Css -->
        <link href="assets/css/bootstrap.min.css" id="bootstrap-style" rel="stylesheet" type="text/css" />
        <!-- Icons Css -->
        <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
        <!-- App Css-->
        <link href="assets/css/app.min.css" id="app-style" rel="stylesheet" type="text/css" />

    </head>

    <body data-sidebar="dark">

    <!-- <body data-layout="horizontal" data-topbar="dark"> -->

        <!-- Begin page -->
        <div id="layout-wrapper">

            
            <header id="page-topbar">
                <div class="navbar-header">
                    <div class="d-flex">
                        <!-- LOGO -->
                        <div class="navbar-brand-box">
                            <a href="index.html" class="logo logo-dark">
                                <span class="logo-sm">
                                    <img src="assets/images/logo.svg" alt="" height="22">
                                </span>
                                <span class="logo-lg">
                                    <img src="assets/images/logo-dark.png" alt="" height="17">
                                </span>
                            </a>

                            <a href="index.html" class="logo logo-light">
                                <span class="logo-sm">
                                    <img src="assets/images/logo-light.svg" alt="" height="22">
                                </span>
                                <span class="logo-lg">
                                    <img src="assets/images/logo-light.png" alt="" height="19">
                                </span>
                            </a>
                        </div>

                     

                    </div>

                   
                </div>
            </header>

            <!-- ========== Left Sidebar Start ========== -->
            <div class="vertical-menu">

                <div data-simplebar class="h-100">

                    <!--- Sidemenu -->
                    <div id="sidebar-menu">
                        <!-- Left Menu Start -->
                        <ul class="metismenu list-unstyled" id="side-menu">
                            <li class="menu-title" key="t-menu">Menu</li>

                        
                            <li>
                                <a href="authors.html" class="waves-effect">
                                    <i class="bx bx-calendar"></i>
                                    <span key="t-calendar">Authors Management</span>
                                </a>
                            </li>

                            <li>
                                <a href="books.html" class="waves-effect">
                                    <i class="bx bx-chat"></i>
                                    <span key="t-chat">Book Management</span>
                                </a>
                            </li>

                            <li>
                                <a href="customer.html" class="waves-effect">
                                    <i class="bx bx-file"></i>
                                    <span key="t-file-manager">Customer Management</span>
                                </a>
                            </li>

                            <li>
                                <a href="orders.html" class="waves-effect">
                                    <i class="bx bx-file"></i>
                                    <span key="t-file-manager">Order Management</span>
                                </a>
                            </li>
                           
                        </ul>
                    </div>
                    <!-- Sidebar -->
                </div>
            </div>
            <!-- Left Sidebar End -->

            

            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="main-content">

                <div class="page-content">
                    <div class="container-fluid">

                        <!-- start page title -->
                        <div class="row">
                            <div class="col-12">
                                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                    <h4 class="mb-sm-0 font-size-18">Dashboard</h4>

                                    <div class="page-title-right">
                                        <ol class="breadcrumb m-0">
                                            <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboards</a></li>
                                            <li class="breadcrumb-item active">Dashboard</li>
                                        </ol>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <!-- end page title -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-sm-4">
                                                <div class="search-box me-2 mb-2 d-inline-block">
                                                    <div class="position-relative">
                                                        <input type="text" class="form-control" placeholder="Search...">
                                                        <i class="bx bx-search-alt search-icon"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-8">
                                                <div class="text-sm-end">
                                                    <button type="button" class="btn btn-success btn-rounded waves-effect waves-light mb-2 me-2" data-bs-toggle="modal" data-bs-target="#addOrderModal"><i class="mdi mdi-plus me-1"></i> New Order</button>
                                                </div>
                                            </div><!-- end col-->
                                        </div>

                                        <div class="table-responsive">
                                            <table class="table align-middle table-nowrap">
                                                <thead>
                                                    <tr> 
                                                        <th>Order ID</th>
                                                        <th>Customer</th>
                                                        <th>Order Date</th>
                                                        <th>Total Amount</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="ordersList">
                                                   
                                                </tbody>
                                            </table>
                                        </div>
                                        <ul class="pagination pagination-rounded justify-content-end mb-2">
                                            <li class="page-item disabled">
                                                <a class="page-link" href="javascript: void(0);" aria-label="Previous">
                                                    <i class="mdi mdi-chevron-left"></i>
                                                </a>
                                            </li>
                                            <li class="page-item active"><a class="page-link" href="javascript: void(0);">1</a></li>
                                            <li class="page-item"><a class="page-link" href="javascript: void(0);">2</a></li>
                                           
                                            <li class="page-item">
                                                <a class="page-link" href="javascript: void(0);" aria-label="Next">
                                                    <i class="mdi mdi-chevron-right"></i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <!-- end col -->
                        </div>
                        <!-- end row -->
                       
                    </div>
                    <!-- container-fluid -->
                </div>
                <!-- End Page-content -->

                <!-- Add Order Modal -->
                <!-- Add Order Modal -->
                <div id="addOrderModal" class="modal fade" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="orderModalLabel">Add New Order</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customerSelect" class="form-label">Select Customer</label>
                                    <select class="form-select" id="customerSelect">
                                        <!-- Customers will be dynamically loaded here -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="bookSelect" class="form-label">Select Book</label>
                                    <select class="form-select" id="bookSelect">
                                        <!-- Books will be dynamically loaded here -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="quantity" class="form-label">Order Quantity</label>
                                    <input type="number" class="form-control" id="quantity" min="1">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" onclick="addOrder()" class="btn btn-primary">Place Order</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Order Modal -->


                <!-- Order Details Modal -->
                <div id="orderDetailsModal" class="modal fade" tabindex="-1" aria-labelledby="orderDetailsLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="orderDetailsLabel">Order Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="orderDetailsBody">
                                <!-- Order details will be dynamically inserted here -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Order Details Modal -->

 
                 <!-- Delete Confirmation Modal -->
                <div class="modal fade" id="deleteOrderModal" tabindex="-1" aria-labelledby="deleteOrderModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="deleteOrderModalLabel">Confirm Deletion</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Are you sure you want to delete this order?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Delete Confirmation Modal -->

                <footer class="footer">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-sm-6">
                                <script>document.write(new Date().getFullYear())</script> © Skote.
                            </div>
                            <div class="col-sm-6">
                                <div class="text-sm-end d-none d-sm-block">
                                    Design & Develop by Themesbrand
                                </div>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>
            <!-- end main content-->

        </div>
        <!-- END layout-wrapper -->

      

        <!-- Right bar overlay-->
        <div class="rightbar-overlay"></div>

        <!-- JAVASCRIPT -->
        <script src="assets/libs/jquery/jquery.min.js"></script>
        <script src="assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/libs/metismenu/metisMenu.min.js"></script>
        <script src="assets/libs/simplebar/simplebar.min.js"></script>
        <script src="assets/libs/node-waves/waves.min.js"></script>

        <!-- apexcharts -->
        <script src="assets/libs/apexcharts/apexcharts.min.js"></script>

        <!-- dashboard init -->
        <script src="assets/js/pages/dashboard.init.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <!-- App js -->
        <script src="assets/js/app.js"></script>

        <script>
            
        /** Create New Order from API **/
        async function addOrder() {
            let customerId = document.getElementById("customerSelect").value; // Get customer id from select dropdown
            let bookId = document.getElementById("bookSelect").value; // Get book id from select dropdown
            let quantity = document.getElementById("quantity").value; // Get quantity value from input field

            // Debugging: Log the values to check if they are correct
            console.log("customerId:", customerId);
            console.log("bookId:", bookId);
            console.log("quantity:", quantity);

            // Validate input fields
            if (!customerId || !bookId || !quantity || quantity < 1) {
                alert("Please fill all fields correctly.");
                return;
            }

            // Prepare the order details as per your API's structure
            let orderDetails = [{
                "book_id": bookId,
                "quantity": quantity,
                "line_total": parseFloat(quantity) * 20.0 // Assuming book price is 20.0, replace with dynamic value if necessary
            }];

            // Prepare the request data
            let orderData = {
                "customer_id": customerId,
                "order_details": orderDetails
            };

            try {
                let URL = "https://bs-api.sobuj.net/view/orders/readOrders.php"; // Your API URL

                // Send the POST request with JSON data
                let response = await axios.post(URL, orderData, {
                    headers: {
                        "Content-Type": "application/json" // Set the content type to JSON
                    }
                });

                // Handle the response
                if (response.data.message === "Order created successfully") {
                    alert("Order placed successfully!");

                    // Close the modal after successful order placement
                    let addOrderModal = new bootstrap.Modal(document.getElementById('addOrderModal'));
                    addOrderModal.hide();
                    getOrders(); // Refresh orders list
                } else {
                    alert("Failed to place order: " + response.data.message);
                }
            } catch (error) {
                console.error("Error adding order:", error);
                alert("An error occurred while placing the order. Please try again.");
            }
        }
        /** Create New Order from API **/




        /** Function to load customers and books into the modal's select dropdowns **/
        async function loadCustomersAndBooks() {
            try {
                // Fetch customers data from the backend
                let customerResponse = await axios.get("https://bs-api.sobuj.net/view/customers/readCustomers.php");
                let customers = customerResponse.data;

                let customerSelect = document.getElementById("customerSelect");
                customerSelect.innerHTML = ''; // Clear any existing options
                customers.forEach(customer => {
                    let option = document.createElement("option");
                    option.value = customer.id;
                    option.textContent = customer.name; // assuming customer has id and name properties
                    customerSelect.appendChild(option);
                });

                // Fetch books data from the backend
                let bookResponse = await axios.get("https://bs-api.sobuj.net/view/books/readBook.php"); // corrected the URL
                let books = bookResponse.data;

                let bookSelect = document.getElementById("bookSelect");
                bookSelect.innerHTML = ''; // Clear any existing options
                books.forEach(book => {
                    let option = document.createElement("option");
                    option.value = book.id;
                    option.textContent = book.title; // assuming book has id and title properties
                    bookSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading customers and books:", error);
            }
        }
        /** Function to load customers and books into the modal's select dropdowns **/

        // Call the loadCustomersAndBooks function when the modal is opened
        document.getElementById('addOrderModal').addEventListener('show.bs.modal', loadCustomersAndBooks);
        /** Function to load customers and books into the modal's select dropdowns**/


        /** Get Orders from API **/
        async function getOrders() {
            let URL = "https://bs-api.sobuj.net/view/orders/readOrders.php";
            let tableData = document.getElementById("ordersList");
            
            try {
                tableData.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

                let response = await axios.get(URL);
                tableData.innerHTML = '';

                if (!response.data.length) {
                    tableData.innerHTML = "<tr><td colspan='5'>No Orders Found</td></tr>";
                    return;
                }

                // Populate order data
                response.data.forEach(order => {
                    let row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${order.order_id}</td>
                        <td>${order.customer_name}</td>
                        <td>${order.order_date}</td>
                        <td>$${order.total_amount}</td>
                        <td>
                            <button class="btn btn-info view-btn" data-id="${order.order_id}">View</button>
                            <button class="btn btn-danger delete-btn" data-id="${order.order_id}">Delete</button>
                        </td>
                    `;
                    tableData.appendChild(row);
                });

                // Add Event Listeners for "View" and "Delete" actions
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        viewOrderDetails(this.dataset.id);
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        deleteOrder(this.dataset.id);
                    });
                });

            } catch (error) {
                console.error("Error fetching orders:", error);
                tableData.innerHTML = "<tr><td colspan='5'>Failed to load orders</td></tr>";
            } finally {
                console.log("Order fetch attempt completed");
            }
        }
        // Call function on page load
        getOrders();
        /** Get Orders from API **/

        /** View Order Details **/
        async function viewOrderDetails(orderId) {
            let URL = `https://bs-api.sobuj.net/view/orders/getOrderById.php?order_id=${orderId}`;
            let modalBody = document.getElementById("orderDetailsBody");

            try {
                let response = await axios.get(URL);
                let order = response.data;

                // Display Order Details
                modalBody.innerHTML = `
                    <p><strong>Order ID:</strong> ${order.order_id}</p>
                    <p><strong>Customer:</strong> ${order.customer_name} (${order.customer_email})</p>
                    <p><strong>Order Date:</strong> ${order.order_date}</p>
                    <p><strong>Total Amount:</strong> $${order.total_amount}</p>
                    <h5>Order Items:</h5>
                    <ul>
                        ${order.order_details.map(item => `
                            <li>
                                <strong>${item.book_title}</strong> - ${item.quantity} × $${item.price} = $${item.line_total}
                            </li>
                        `).join('')}
                    </ul>
                `;

                // Show modal
                let modalElement = new bootstrap.Modal(document.getElementById("orderDetailsModal"));
                modalElement.show();

            } catch (error) {
                console.error("Error fetching order details:", error);
                alert("Failed to fetch order details.");
            }
        }
        /** View Order Details **/

        

        /** Delete Order **/
        let orderIdToDelete = null; // Store the order ID to delete
        async function deleteOrder(orderId) {
            orderIdToDelete = orderId; // Store the ID of the order to delete

            // Show the confirmation modal
            let deleteModal = new bootstrap.Modal(document.getElementById('deleteOrderModal'));
            deleteModal.show();
        }

        // Handle confirmation of deletion
        document.getElementById("confirmDeleteBtn").addEventListener("click", async function () {
            let URL = `https://bs-api.sobuj.net/view/orders/deleteOrder.php?order_id=${orderIdToDelete}`;

            try {

                let formData = new FormData();
                formData.append("order_id",orderIdToDelete);
                let response = await axios.post(URL,formData);

                if (response.status === 200) {
                    alert("Order deleted successfully!");

                    // Close the modal after confirmation
                    let deleteModal = new bootstrap.Modal(document.getElementById('deleteOrderModal'));
                    deleteModal.hide();

                    getOrders(); // Refresh the order list
                } else {
                    alert("Failed to delete order: " + response.data.error);
                }

            } catch (error) {
                console.error("Error deleting order:", error);
                alert("An error occurred. Please try again.");
            }
        });
        /** Delete Order **/



        </script>
    </body>

</html>