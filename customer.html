<!doctype html>
<html lang="en">

    <head>
        
        <meta charset="utf-8" />
        <title>Dashboard | Books</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta content="Premium Multipurpose Admin & Dashboard Template" name="description" />
        <meta content="Themesbrand" name="author" />
        <!-- App favicon -->
        <link rel="shortcut icon" href="assets/images/favicon.ico">

        <!-- Bootstrap Css -->
        <link href="assets/css/bootstrap.min.css" id="bootstrap-style" rel="stylesheet" type="text/css" />
        <!-- Icons Css -->
        <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
        <!-- App Css-->
        <link href="assets/css/app.min.css" id="app-style" rel="stylesheet" type="text/css" />

    </head>

    <body data-sidebar="dark">

    <!-- <body data-layout="horizontal" data-topbar="dark"> -->

        <!-- Begin page -->
        <div id="layout-wrapper">

            
            <header id="page-topbar">
                <div class="navbar-header">
                    <div class="d-flex">
                        <!-- LOGO -->
                        <div class="navbar-brand-box">
                            <a href="index.html" class="logo logo-dark">
                                <span class="logo-sm">
                                    <img src="assets/images/logo.svg" alt="" height="22">
                                </span>
                                <span class="logo-lg">
                                    <img src="assets/images/logo-dark.png" alt="" height="17">
                                </span>
                            </a>

                            <a href="index.html" class="logo logo-light">
                                <span class="logo-sm">
                                    <img src="assets/images/logo-light.svg" alt="" height="22">
                                </span>
                                <span class="logo-lg">
                                    <img src="assets/images/logo-light.png" alt="" height="19">
                                </span>
                            </a>
                        </div>

                     

                    </div>

                   
                </div>
            </header>

            <!-- ========== Left Sidebar Start ========== -->
            <div class="vertical-menu">

                <div data-simplebar class="h-100">

                    <!--- Sidemenu -->
                    <div id="sidebar-menu">
                        <!-- Left Menu Start -->
                        <ul class="metismenu list-unstyled" id="side-menu">
                            <li class="menu-title" key="t-menu">Menu</li>

                        
                            <li>
                                <a href="authors.html" class="waves-effect">
                                    <i class="bx bx-calendar"></i>
                                    <span key="t-calendar">Authors Management</span>
                                </a>
                            </li>

                            <li>
                                <a href="books.html" class="waves-effect">
                                    <i class="bx bx-chat"></i>
                                    <span key="t-chat">Book Management</span>
                                </a>
                            </li>

                            <li>
                                <a href="customer.html" class="waves-effect">
                                    <i class="bx bx-file"></i>
                                    <span key="t-file-manager">Customer Management</span>
                                </a>
                            </li>

                            <li>
                                <a href="orders.html" class="waves-effect">
                                    <i class="bx bx-file"></i>
                                    <span key="t-file-manager">Order Management</span>
                                </a>
                            </li>

                        </ul>
                    </div>
                    <!-- Sidebar -->
                </div>
            </div>
            <!-- Left Sidebar End -->

            

            <!-- ============================================================== -->
            <!-- Start right Content here -->
            <!-- ============================================================== -->
            <div class="main-content">

                <div class="page-content">
                    <div class="container-fluid">

                        <!-- start page title -->
                        <div class="row">
                            <div class="col-12">
                                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                    <h4 class="mb-sm-0 font-size-18">Dashboard</h4>

                                    <div class="page-title-right">
                                        <ol class="breadcrumb m-0">
                                            <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboards</a></li>
                                            <li class="breadcrumb-item active">Dashboard</li>
                                        </ol>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <!-- end page title -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row mb-2">
                                            <div class="col-sm-4">
                                                <div class="search-box me-2 mb-2 d-inline-block">
                                                    <div class="position-relative">
                                                        <input type="text" class="form-control" placeholder="Search...">
                                                        <i class="bx bx-search-alt search-icon"></i>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-8">
                                                <div class="text-sm-end">
                                                    <button type="button" class="btn btn-success btn-rounded waves-effect waves-light mb-2 me-2" data-bs-toggle="modal" data-bs-target="#addCustomerModal"><i class="mdi mdi-plus me-1"></i> Add New Customer</button>
                                                </div>
                                            </div><!-- end col-->
                                        </div>

                                        <div class="table-responsive">
                                            <table class="table align-middle table-nowrap">
                                                <thead>
                                                    <tr> 
                                                        <th>ID</th>
                                                        <th>Name</th>
                                                        <th>Email</th>
                                                        <th>Phone</th> 
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="customersList">
                                                   
                                                </tbody>
                                            </table>
                                        </div>
                                        <ul class="pagination pagination-rounded justify-content-end mb-2">
                                            <li class="page-item disabled">
                                                <a class="page-link" href="javascript: void(0);" aria-label="Previous">
                                                    <i class="mdi mdi-chevron-left"></i>
                                                </a>
                                            </li>
                                            <li class="page-item active"><a class="page-link" href="javascript: void(0);">1</a></li>
                                            <li class="page-item"><a class="page-link" href="javascript: void(0);">2</a></li>
                                           
                                            <li class="page-item">
                                                <a class="page-link" href="javascript: void(0);" aria-label="Next">
                                                    <i class="mdi mdi-chevron-right"></i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <!-- end col -->
                        </div>
                        <!-- end row -->
                       
                    </div>
                    <!-- container-fluid -->
                </div>
                <!-- End Page-content -->

                <!-- Add Book modal -->
                <!-- Add Customer Modal -->
                <div id="addCustomerModal" class="modal fade" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="customerModalLabel">Add New Customer</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customerName" class="form-label">Customer Name</label>
                                    <input type="text" class="form-control" id="customerName">
                                </div>
                                <div class="mb-3">
                                    <label for="customerEmail" class="form-label">Customer Email</label>
                                    <input type="email" class="form-control" id="customerEmail">
                                </div>
                                <div class="mb-3">
                                    <label for="customerPhone" class="form-label">Customer Phone</label>
                                    <input type="text" class="form-control" id="customerPhone">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" onclick="addCustomer()" class="btn btn-primary">Save Customer</button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Edit Customer Modal -->
                <div id="editCustomerModal" class="modal fade" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="myModalLabel">Edit Customer</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                
                                    <!-- Hidden Input for Customer ID -->
                                    <input type="hidden" id="editCustomerId" />

                                    <div class="mb-3">
                                        <label for="editCustomerName" class="form-label">Name</label>
                                        <input type="text" class="form-control" name="name" id="editCustomerName">
                                    </div>
                                    <div class="mb-3">
                                        <label for="editCustomerEmail" class="form-label">Email</label>
                                        <input type="text" class="form-control" name="email" id="editCustomerEmail">
                                    </div>
                                    <div class="mb-3">
                                        <label for="editCustomerPhone" class="form-label">Phone</label>
                                        <input type="text" class="form-control" name="phone" id="editCustomerPhone">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary waves-effect" data-bs-dismiss="modal">Close</button>
                                    <button type="button" onclick="updateCustomer()"  class="btn btn-primary waves-effect waves-light">Save changes</button>
                                </div>
                          
                        </div><!-- /.modal-content -->
                    </div><!-- /.modal-dialog -->
                </div><!-- /.modal -->





                <!-- Delete Confirmation Modal -->
                <div id="deleteCustomerModal" class="modal fade" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to delete this customer?</p>
                                <!-- Hidden field to store book ID -->
                                <input type="hidden" id="deleteCustomerId">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" onclick="confirmDeleteCustomer()">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>


                <footer class="footer">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-sm-6">
                                <script>document.write(new Date().getFullYear())</script> Â© Skote.
                            </div>
                            <div class="col-sm-6">
                                <div class="text-sm-end d-none d-sm-block">
                                    Design & Develop by Themesbrand
                                </div>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>
            <!-- end main content-->

        </div>
        <!-- END layout-wrapper -->



        <!-- Right bar overlay-->
        <div class="rightbar-overlay"></div>

        <!-- JAVASCRIPT -->
        <script src="assets/libs/jquery/jquery.min.js"></script>
        <script src="assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/libs/metismenu/metisMenu.min.js"></script>
        <script src="assets/libs/simplebar/simplebar.min.js"></script>
        <script src="assets/libs/node-waves/waves.min.js"></script>

        <!-- apexcharts -->
        <script src="assets/libs/apexcharts/apexcharts.min.js"></script>

        <!-- dashboard init -->
        <script src="assets/js/pages/dashboard.init.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <!-- App js -->
        <script src="assets/js/app.js"></script>

        <script>
            /** Get Customer from API **/
            async function getCustomers() {
                const URL = "https://bs-api.sobuj.net/view/customers/readCustomers.php";
                const tableData = document.getElementById("customersList");
                // Display loading message
                tableData.innerHTML = `<tr><td colspan="5">Loading.....</td></tr>`;
                try {
                    
                    const response = await axios.get(URL);
                    // Clear loading message
                    tableData.innerHTML = '';

                    if (response.data.length === 0) {
                        tableData.innerHTML = "<tr><td colspan='5'>No Customers Data Found</td></tr>";
                        return;
                    }

                    // Populate customer data
                    response.data.forEach(customer => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${customer.customer_id}</td>
                            <td>${customer.name}</td>
                            <td>${customer.email}</td>
                            <td>${customer.phone}</td>
                            <td>
                                <a href="#" class="btn btn-success edit-btn" data-id="${customer.customer_id}"><i class="mdi mdi-pencil font-size-16 text-light me-1"></i> Edit</a>
                                <a href="#" class="btn btn-danger delete-btn" data-id="${customer.customer_id}"><i class="mdi mdi-trash-can font-size-16 text-light me-1"></i> Delete</a>
                            </td>
                        `;
                        tableData.appendChild(row);
                    });

                    // Add Event Listeners for edit and delete actions
                    document.querySelectorAll('.edit-btn').forEach(btn => {
                        btn.addEventListener("click", function () {
                            editCustomer(this.dataset.id);
                        });
                    });

                    // Add Event Listeners for edit and delete actions
                    document.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener("click", function () {
                            openDeleteCustomerModal(this.dataset.id);
                        });
                    });
                } catch (error) {
                    console.error(`Error: ${error.message}`);
                    tableData.innerHTML = "<tr><td colspan='5'>Failed to load cutomer data</td></tr>";
                } finally{
                    console.log("Customer fetch attempt completed");
                }
            }
            getCustomers();
            /** Get Customer from API **/

             /** Add Customer **/
             // Insert Customer
            async function addCustomer() {
                
                let URL = "https://bs-api.sobuj.net/view/customers/insertCustomer.php";
                let name = document.getElementById("customerName").value.trim();
                let email = document.getElementById("customerEmail").value.trim();
                let phone = document.getElementById("customerPhone").value.trim();
                
                try {
                    if (!name || !email || !phone) {
                        alert("Please fill all fields.");
                        return;
                    }

                    // Append Data
                    let formData = new FormData();
                    formData.append("name", name);
                    formData.append("email", email);
                    formData.append("phone", phone);

                    // Send data request
                    let response = await axios.post(URL, formData, {
                        headers: {
                            "Content-Type": "multipart/form-data"
                        }
                    });
                    console.log("API Response:", response.data);

                    // Check API response
                    if (response.status === 200) {
                        alert("Customer added successfully!");
                        document.getElementById("customerName").value = '';
                        document.getElementById("customerEmail").value = '';
                        document.getElementById("customerPhone").value = '';

                        // Close modal safely
                        let modalElement = document.getElementById("addCustomerModal");
                        let modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) modal.hide();

                        // Refresh customer list
                        getCustomers();
                    } else {
                        alert("Failed to add customer: " + response.data.error);
                    }
                } catch (error) {
                    console.error("Error adding customer:", error);
                    alert("An error occurred. Please try again.");
                } finally {
                    console.log('Customer add attempt completed');
                }
            }

             /** Add Customer **/
            
            /** Edit Customer from API **/
            async function editCustomer(customerId) {
                const URL = `https://bs-api.sobuj.net/view/customers/getCustomerById.php?customer_id=${customerId}`;
                const editCustomerForm = document.getElementById("editCustomerForm");

                try {
                    // Fetch current customer data
                    const response = await axios.get(URL);
                    const customerData = response.data;

                    // Log fetched customer data to check if fetched correctly
                    console.log("Fetched Customer Data: ", customerData);

                    // Ensure customer data is properly retrieved
                    if (response.data.message === 'Customer ID is required') {
                        alert("Failed to fetch customer data: Customer ID is required.");
                        return;
                    }

                    // Fill form with current customer data
                    document.getElementById("editCustomerId").value = customerData.customer_id;
                    document.getElementById("editCustomerName").value = customerData.name;
                    document.getElementById("editCustomerEmail").value = customerData.email;
                    document.getElementById("editCustomerPhone").value = customerData.phone;
                    
                    // Show Edit Modal
                    $('#editCustomerModal').modal('show');
                } catch (error) {
                    console.error(`Error fetching customer data: ${error.message}`);
                }
            }
            /** Edit Customer from API **/


            /** Update Customer Data **/
            async function updateCustomer() {
                    const URL = `https://bs-api.sobuj.net/view/customers/updateCustomer.php`;
                    let editCustomerId = document.getElementById("editCustomerId").value.trim();
                    let editCustomerName = document.getElementById("editCustomerName").value.trim();
                    let editCustomerEmail = document.getElementById("editCustomerEmail").value.trim();
                    let editCustomerPhone = document.getElementById("editCustomerPhone").value.trim();
                    try{
                        // validate
                        if (!editCustomerName || !editCustomerEmail || !editCustomerPhone) {
                            alert("All data required");
                            return;
                        }
                        // Append Data
                        let formData = new FormData();
                        formData.append("customer_id", editCustomerId);
                        formData.append("name",editCustomerName);
                        formData.append("email",editCustomerEmail);
                        formData.append("phone",editCustomerPhone);

                        // Send data request
                        let response = await axios.post(URL,formData);

                        // Check api response
                        if (response.status === 200) {
                            alert("Customer successfully Updated");
                            document.getElementById("editCustomerName").value = '';
                            document.getElementById("editCustomerEmail").value = '';
                            document.getElementById("editCustomerPhone").value = '';

                            // Close modal safely
                            let modalElement = document.getElementById("editCustomerModal");
                            let modal = bootstrap.Modal.getInstance(modalElement);
                            if (modal) {
                                modal.hide();
                            }

                            // refresh list
                            getCustomers();
                        } else{
                            alert("Failed to update customer");
                        }
                    } catch (error){
                        console.error("Error for updating customer",error);
                        alert("Failed, try again");
                    } finally {
                        console.log('Customer add attempt completed');
                    }
                }

            /** Update Customer Data **/


            
            // Function to open delete confirmation modal
            function openDeleteCustomerModal(customerId) {
                // Set the book ID in the hidden field
                document.getElementById("deleteCustomerId").value = customerId;

                // Show the delete modal
                let deleteModal = new bootstrap.Modal(document.getElementById('deleteCustomerModal'));
                deleteModal.show();
            }


            // Confirm Function to delete a customer
            async function confirmDeleteCustomer() {
                let customerId = document.getElementById("deleteCustomerId").value;
                let URL = `https://bs-api.sobuj.net/view/customers/deleteCustomer.php?customer_id=${customerId}`;

                try {
                    // Append data
                    let formData = new FormData();
                    formData.append("customer_id",customerId);
                    let response = await axios.post(URL,formData);

                    if (response.status === 200) {
                        alert("Book deleted successfully!");
                        
                        // Hide the modal
                        let deleteModal = bootstrap.Modal.getInstance(document.getElementById("deleteCustomerModal"));
                        if (deleteModal) deleteModal.hide();

                        // Refresh the book list
                        getCustomers();
                    } else {
                        alert("Failed to delete the customer.");
                    }
                } catch (error) {
                    console.error("Error deleting the customer:", error);
                    alert("An error occurred while deleting the customer. Please try again.");
                }
            }
            // Confirm Function to delete a customer

        </script>
    </body>

</html>